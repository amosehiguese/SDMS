{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Change Password" %} - {{ site_config.site_name|default:"SuccessDirectMarketStore" }}{% endblock %}

{% block extra_head %}
<style>
    .password-toggle-btn {
        z-index: 20 !important;
        pointer-events: auto !important;
    }
    
    .password-toggle-btn:hover i {
        color: #374151 !important;
    }
    
    .password-toggle-btn:focus {
        outline: 2px solid #f59e0b;
        outline-offset: 2px;
    }
    
    /* Smooth icon transitions */
    .password-toggle-btn i {
        transition: color 0.2s ease-in-out;
    }
    
    /* Ensure input doesn't interfere */
    .password-input-container input {
        position: relative;
        z-index: 1;
    }
    
    .password-input-container .password-toggle-btn {
        position: absolute;
        z-index: 10;
        right: 0;
        top: 0;
        bottom: 0;
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md mx-auto">
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">
                    {% trans "Change Password" %}
                </h1>
                
                <form method="post" action="{% url 'account_change_password' %}">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-md mb-4">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="space-y-4">
                        <div>
                            <label for="{{ form.oldpassword.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                {% trans "Current Password" %}
                            </label>
                            <div class="mt-1 password-input-container relative">
                                <input id="{{ form.oldpassword.id_for_label }}" 
                                       name="{{ form.oldpassword.name }}" 
                                       type="password" 
                                       autocomplete="current-password" 
                                       required 
                                       class="appearance-none relative block w-full px-3 py-2 pr-12 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
                                       placeholder="{% trans 'Current password' %}">
                                <button type="button" 
                                        data-password-toggle="{{ form.oldpassword.id_for_label }}"
                                        class="password-toggle-btn"
                                        aria-label="Show password"
                                        tabindex="0">
                                    <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                </button>
                            </div>
                            {% if form.oldpassword.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.oldpassword.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.password1.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                {% trans "New Password" %}
                            </label>
                            <div class="mt-1 password-input-container relative">
                                <input id="{{ form.password1.id_for_label }}" 
                                       name="{{ form.password1.name }}" 
                                       type="password" 
                                       autocomplete="new-password" 
                                       required 
                                       class="appearance-none relative block w-full px-3 py-2 pr-12 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
                                       placeholder="{% trans 'Enter new password' %}">
                                <button type="button" 
                                        data-password-toggle="{{ form.password1.id_for_label }}"
                                        class="password-toggle-btn"
                                        aria-label="Show password"
                                        tabindex="0">
                                    <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                </button>
                            </div>
                            {% if form.password1.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.password1.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.password2.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                {% trans "Confirm New Password" %}
                            </label>
                            <div class="mt-1 password-input-container relative">
                                <input id="{{ form.password2.id_for_label }}" 
                                       name="{{ form.password2.name }}" 
                                       type="password" 
                                       autocomplete="new-password" 
                                       required 
                                       class="appearance-none relative block w-full px-3 py-2 pr-12 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm"
                                       placeholder="{% trans 'Confirm new password' %}">
                                <button type="button" 
                                        data-password-toggle="{{ form.password2.id_for_label }}"
                                        class="password-toggle-btn"
                                        aria-label="Show password"
                                        tabindex="0">
                                    <i class="fas fa-eye text-gray-400 hover:text-gray-600"></i>
                                </button>
                            </div>
                            {% if form.password2.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.password2.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="submit" 
                                class="flex-1 flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                            {% trans "Change Password" %}
                        </button>
                        
                        <a href="{% url 'core:profile' %}" 
                           class="flex-1 flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                            {% trans "Cancel" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function initPasswordToggle() {
    // Find all password toggle buttons
    const toggleButtons = document.querySelectorAll('[data-password-toggle]');
    
    toggleButtons.forEach((button) => {
        const inputId = button.getAttribute('data-password-toggle');
        const input = document.getElementById(inputId);
        const icon = button.querySelector('i');
        
        if (!input || !icon) {
            return;
        }
        
        // Remove any existing event listeners by cloning the button
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Get the new icon reference
        const newIcon = newButton.querySelector('i');
        
        // Add mouse events
        newButton.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        newButton.addEventListener('mouseup', function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
        
        // Handle click event
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isPassword = input.type === 'password';
            
            // Store cursor position before changing type
            const cursorStart = input.selectionStart;
            const cursorEnd = input.selectionEnd;
            
            // Toggle input type
            input.type = isPassword ? 'text' : 'password';
            
            // Update icon and accessibility
            if (isPassword) {
                // Showing password
                newIcon.classList.remove('fa-eye');
                newIcon.classList.add('fa-eye-slash');
                newButton.setAttribute('aria-label', 'Hide password');
                newButton.setAttribute('title', 'Hide password');
            } else {
                // Hiding password
                newIcon.classList.remove('fa-eye-slash');
                newIcon.classList.add('fa-eye');
                newButton.setAttribute('aria-label', 'Show password');
                newButton.setAttribute('title', 'Show password');
            }
            
            // Restore cursor position and focus
            setTimeout(() => {
                input.focus();
                if (cursorStart !== null && cursorEnd !== null) {
                    input.setSelectionRange(cursorStart, cursorEnd);
                }
            }, 0);
        });
        
        // Add keyboard support for accessibility
        newButton.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
        
        // Add touch events for mobile
        newButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
        });
        
        newButton.addEventListener('touchend', function(e) {
            e.preventDefault();
            this.click();
        });
    });
}

// Multiple initialization attempts to ensure it works
document.addEventListener('DOMContentLoaded', function() {
    initPasswordToggle();
});

// Fallback initialization
setTimeout(function() {
    initPasswordToggle();
}, 100);

// Also initialize if the script loads after DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordToggle);
} else {
    initPasswordToggle();
}
</script>
{% endblock %}