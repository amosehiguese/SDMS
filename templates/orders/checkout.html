{% extends 'base.html' %}

{% block title %}Checkout - {{ site_config.site_name|default:"SuccessDirectMarketStore" }}{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="bg-gray-100 py-4">
    <div class="container mx-auto px-4">
        <nav class="text-sm">
            <a href="{% url 'store:home' %}" class="text-amber-700 hover:text-yellow-700">Home</a>
            <span class="mx-2">/</span>
            <a href="{% url 'orders:cart' %}" class="text-amber-700 hover:text-yellow-700">Cart</a>
            <span class="mx-2">/</span>
            <span class="text-gray-600">Checkout</span>
        </nav>
    </div>
</div>

<!-- Checkout Steps -->
<div class="bg-white border-b">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-center space-x-8">
            <div class="flex items-center text-amber-700">
                <div class="w-8 h-8 bg-amber-700 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                <span class="ml-2 font-semibold">Shipping</span>
            </div>
            <div class="w-12 h-px bg-gray-300"></div>
            <div class="flex items-center text-gray-400">
                <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                <span class="ml-2">Payment</span>
            </div>
            <div class="w-12 h-px bg-gray-300"></div>
            <div class="flex items-center text-gray-400">
                <div class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
                <span class="ml-2">Review</span>
            </div>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-8">
    <form id="checkout-form" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Shipping Information -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-shipping-fast mr-3 text-yellow-500"></i>
                    Shipping Information
                </h2>
                
                <!-- Existing Addresses -->
                {% if user.shipping_addresses.exists %}
                <div class="mb-6">
                    <h3 class="font-semibold mb-4">Select Shipping Address</h3>
                    <div class="space-y-3">
                        {% for address in user.shipping_addresses.all %}
                        <label class="flex items-start p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-amber-700 transition">
                            <input type="radio" name="shipping_address" value="{{ address.id }}" class="mt-1 mr-3" {% if forloop.first %}checked{% endif %}>
                            <div class="flex-1">
                                <div class="font-semibold">{{ address.full_name }}</div>
                                <div class="text-sm text-gray-600">
                                    {{ address.street_address }}<br>
                                    {{ address.city }}, {{ address.state }} {{ address.postal_code }}<br>
                                    {{ address.country }}
                                </div>
                                {% if address.phone_number %}
                                    <div class="text-sm text-gray-600">{{ address.phone_number }}</div>
                                {% endif %}
                            </div>
                            {% if address.is_default %}
                                <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Default</span>
                            {% endif %}
                        </label>
                        {% endfor %}
                    </div>
                    
                    <button type="button" onclick="showNewAddressForm()" class="mt-4 text-amber-700 hover:text-yellow-700 flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Add New Address
                    </button>
                </div>
                {% endif %}
                
                <!-- New Address Form -->
                <div id="new-address-form" class="{% if user.shipping_addresses.exists %}hidden{% endif %}">
                    <h3 class="font-semibold mb-4">{% if not user.shipping_addresses.exists %}Shipping Address{% else %}New Address{% endif %}</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">First Name *</label>
                            <input type="text" name="first_name" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Last Name *</label>
                            <input type="text" name="last_name" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Street Address *</label>
                            <input type="text" name="street_address" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">City *</label>
                            <input type="text" name="city" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">State *</label>
                            <input type="text" name="state" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Postal Code</label>
                            <input type="text" name="postal_code" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Country *</label>
                            <select name="country" required class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                                <option value="Nigeria">Nigeria</option>
                                <option value="Ghana">Ghana</option>
                                <option value="Kenya">Kenya</option>
                                <option value="South Africa">South Africa</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">Phone Number</label>
                            <input type="tel" name="phone_number" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700">
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="save_address" class="mr-2">
                                <span class="text-sm">Save this address for future orders</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-credit-card mr-3 text-yellow-500"></i>
                    Payment Method
                </h2>
                
                <div class="space-y-4">
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-amber-700 transition">
                        <input type="radio" name="payment_method" value="paystack" class="mr-3" checked>
                        <div class="flex items-center">
                            <i class="fas fa-credit-card text-2xl text-yellow-500 mr-4"></i>
                            <div>
                                <div class="font-semibold">Credit/Debit Card</div>
                                <div class="text-sm text-gray-600">Secure payment via Paystack</div>
                            </div>
                        </div>
                        <div class="ml-auto flex space-x-2">
                            <i class="fab fa-cc-visa text-2xl text-blue-600"></i>
                            <i class="fab fa-cc-mastercard text-2xl text-red-600"></i>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-amber-700 transition opacity-50 cursor-not-allowed">
                        <input type="radio" name="payment_method" value="bank_transfer" class="mr-3" disabled>
                        <div class="flex items-center">
                            <i class="fas fa-university text-2xl text-gray-400 mr-4"></i>
                            <div>
                                <div class="font-semibold text-gray-500">Bank Transfer</div>
                                <div class="text-sm text-gray-400">Coming Soon</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Order Notes -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-sticky-note mr-3 text-yellow-500"></i>
                    Order Notes (Optional)
                </h2>
                
                <textarea name="order_notes" rows="4" placeholder="Any special instructions for your order..." 
                          class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-700"></textarea>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
                <h2 class="text-xl font-bold mb-6">Order Summary</h2>
                
                <!-- Cart Items -->
                <div class="space-y-4 mb-6 max-h-64 overflow-y-auto">
                    {% for item in cart.get_items %}
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 flex-shrink-0">
                            {% if item.product.images.exists %}
                                <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.title }}" class="w-full h-full object-cover rounded">
                            {% else %}
                                <div class="w-full h-full bg-gray-200 flex items-center justify-center rounded">
                                    <i class="fas fa-image text-gray-400 text-xs"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">{{ item.product.title }}</p>
                            <p class="text-xs text-gray-500">
                                Qty: {{ item.quantity }} × ₦{{ item.product.get_display_price|floatformat:0 }}
                            </p>
                            <p class="text-xs text-gray-500">
                                {% if item.purchase_option == 'hold' %}
                                    Hold as Asset
                                {% else %}
                                    Deliver to Me
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-sm font-semibold">
                            ₦{{ item.get_total_price|floatformat:0 }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <hr class="mb-4">
                
                <!-- Price Breakdown -->
                <div class="space-y-2 mb-6 text-sm">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span>₦{{ cart.get_subtotal|floatformat:0 }}</span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span>Shipping</span>
                        <span id="shipping-amount">
                            {% if cart.get_subtotal >= site_config.free_shipping_threshold %}
                                <span class="text-green-600">Free</span>
                            {% else %}
                                ₦{{ site_config.default_shipping_cost|floatformat:0 }}
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if site_config.tax_rate > 0 %}
                    <div class="flex justify-between">
                        <span>Tax</span>
                        <span>₦{{ cart.get_tax_amount|floatformat:0 }}</span>
                    </div>
                    {% endif %}
                    
                    <hr class="my-2">
                    
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total</span>
                        <span class="text-amber-700">₦{{ cart.get_total|floatformat:0 }}</span>
                    </div>
                </div>
                
                <!-- Place Order Button -->
                <button type="submit" class="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition mb-4">
                    <i class="fas fa-lock mr-2"></i>
                    Place Order
                </button>
                
                <!-- Security Info -->
                <div class="text-center text-xs text-gray-500">
                    <i class="fas fa-shield-alt mr-1"></i>
                    Your payment information is secure and encrypted
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize checkout form
    initializeCheckout();
});

function initializeCheckout() {
    // Handle form submission
    $('#checkout-form').on('submit', function(e) {
        e.preventDefault();
        processCheckout();
    });
    
    // Handle payment method changes
    $('input[name="payment_method"]').change(function() {
        updatePaymentMethod();
    });
}

function showNewAddressForm() {
    $('#new-address-form').removeClass('hidden');
    $('input[name="shipping_address"]').prop('checked', false);
}

function processCheckout() {
    // Validate form
    if (!validateCheckoutForm()) {
        return;
    }
    
    showLoading();
    
    const formData = new FormData($('#checkout-form')[0]);
    
    $.ajax({
        url: '{% url "orders:create_order" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
        }
    })
    .done(function(response) {
        hideLoading();
        if (response.success) {
            if (response.payment_url) {
                // Redirect to payment gateway
                window.location.href = response.payment_url;
            } else {
                // Order created successfully
                window.location.href = response.redirect_url;
            }
        } else {
            showNotification(response.error || 'Error processing order', 'error');
        }
    })
    .fail(function() {
        hideLoading();
        showNotification('Error processing order. Please try again.', 'error');
    });
}

function validateCheckoutForm() {
    let isValid = true;
    
    // Check if shipping address is selected or new address form is filled
    const hasSelectedAddress = $('input[name="shipping_address"]:checked').length > 0;
    const isNewAddressFormVisible = !$('#new-address-form').hasClass('hidden');
    
    if (!hasSelectedAddress && isNewAddressFormVisible) {
        // Validate new address form
        const requiredFields = ['first_name', 'last_name', 'street_address', 'city', 'state', 'country'];
        
        requiredFields.forEach(function(fieldName) {
            const field = $(`input[name="${fieldName}"], select[name="${fieldName}"]`);
            if (!field.val().trim()) {
                field.addClass('border-red-500');
                isValid = false;
            } else {
                field.removeClass('border-red-500');
            }
        });
        
        if (!isValid) {
            showNotification('Please fill in all required shipping address fields', 'error');
            return false;
        }
    } else if (!hasSelectedAddress) {
        showNotification('Please select a shipping address', 'error');
        return false;
    }
    
    // Check payment method
    if (!$('input[name="payment_method"]:checked').length) {
        showNotification('Please select a payment method', 'error');
        return false;
    }
    
    return isValid;
}

function updatePaymentMethod() {
    const selectedMethod = $('input[name="payment_method"]:checked').val();
    
    // Update UI based on selected payment method
    if (selectedMethod === 'paystack') {
        // Show credit card info
    } else if (selectedMethod === 'bank_transfer') {
        // Show bank transfer info
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-amber-700'
    };
    
    const notification = $(`
        <div class="fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform">
            ${message}
        </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(() => {
        notification.removeClass('translate-x-full');
    }, 100);
    
    setTimeout(() => {
        notification.addClass('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}
</script>
{% endblock %} 